name: py-bench

on:
  pull_request:
    paths:
      - "python/langsmith/**"

permissions:
  contents: read

jobs:
  benchmark:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: python
    steps:
      - uses: actions/checkout@v6
      - id: files
        name: Get changed files
        uses: Ana06/get-changed-files@v2.3.0
        with:
          format: json

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: 3.11
          enable-cache: true

      - name: Install dependencies
        run: uv sync --group dev

      - name: Download baseline
        id: baseline
        uses: actions/cache/restore@v5
        with:
          key: ${{ runner.os }}-benchmark-baseline
          restore-keys: |
            ${{ runner.os }}-benchmark-baseline-
          fail-on-cache-miss: false
          path: |
            python/out/benchmark-baseline.json
      - name: Run benchmarks
        id: benchmark
        run: |
          {
            echo 'OUTPUT<<EOF'
            make -s benchmark-fast
            echo EOF
          } >> "$GITHUB_OUTPUT"
      - name: Compare benchmarks
        if: steps.baseline.outputs.cache-hit
        id: compare
        run: |
          {
            echo 'OUTPUT<<EOF'
            mv out/benchmark-baseline.json out/main.json
            mv out/benchmark.json out/changes.json
            uv run pyperf compare_to out/main.json out/changes.json --table --group-by-speed
            echo EOF
          } >> "$GITHUB_OUTPUT"
      - name: Annotation
        uses: actions/github-script@v8
        with:
          script: |
            const file = JSON.parse(`${{ steps.files.outputs.added_modified_renamed }}`)[0]
            core.notice(`${{ steps.benchmark.outputs.OUTPUT }}`, {
              title: 'Benchmark results',
              file,
            })
            if (`${{ steps.compare.outputs.OUTPUT }}`) {
              core.notice(`${{ steps.compare.outputs.OUTPUT }}`, {
                title: 'Comparison against main',
                file,
              })
            } else {
              core.warning('No baseline cache found â€” skipping comparison. Baseline will be available after the next push to main.', {
                title: 'Benchmark comparison skipped',
                file,
              })
            }
